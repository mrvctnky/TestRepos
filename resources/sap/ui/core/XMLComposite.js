/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/core/Control','sap/ui/core/XMLCompositeMetadata','sap/ui/model/base/ManagedObjectModel','sap/ui/core/util/XMLPreprocessor','sap/ui/model/json/JSONModel','sap/ui/core/Fragment','sap/ui/base/ManagedObject','sap/ui/base/DataType','sap/ui/model/base/XMLNodeAttributesModel','sap/ui/core/util/reflection/XmlTreeModifier','sap/ui/model/resource/ResourceModel'],function(q,C,X,M,a,J,F,b,D,c,d,R){"use strict";var m={};function e(s,o){if(!m[s]){q.sap.require(s);m[s]=q.sap.getObject(s);}return m[s];}function p(T,v,n,o){var B=b.bindingParser(v,o,true);if(B&&typeof B==="object"){return B;}var V=v=B||v;var i=D.getType(T);if(i){if(i instanceof D){V=i.parseValue(v);}}else{throw new Error("Property "+n+" has unknown type "+T);}return typeof V==="string"?b.bindingParser.escape(V):V;}function f(j,n,E,I,v){var A=new J(E),o=I.getMetadata(),r=o.getAllAggregations(),P=o.getAllProperties(),s=o._mAllSpecialSettings;A.getVisitor=function(){return v;};A._getObject=function(u,w){var x;u=this.resolve(u,w);u=u.substring(1);var y=u.split("/");if(u&&u.startsWith&&u.startsWith("metadataContexts")){return this._navInMetadataContexts(u);}if(P.hasOwnProperty(u)){var z=P[u];if(!E.hasAttribute(u)){return z.defaultValue;}x=v.getResult(E.getAttribute(u))||E.getAttribute(u);if(x){var S=p(z.type,x,u);if(typeof S==="object"&&S.path){return x;}return S;}return null;}else if(r.hasOwnProperty(y[0])){var B=r[y[0]];var G,H=d.getAggregation(E,y[0]);if(!H){return null;}if(B.multiple){var K=[];for(var i=0;i<H.length;i++){G=new c(H[i],v,"");K.push(G.getContext("/"));}x=K;}else{G=new c(H,v,"");x=G.getContext("/");}y.shift();return this._getNode(y,x);}else if(s.hasOwnProperty(u)){var L=s[u];if(!E.hasAttribute(u)){return L.defaultValue||null;}x=v.getResult(E.getAttribute(u));if(L.type){var S=p(L.type,x,u);if(typeof S==="object"&&S.path){return x;}return S;}if(x){return x;}return E.getAttribute(u);}};A._navInMetadataContexts=function(i){var u=i.replace("metadataContexts","");var w=u.split("/"),N=j["metadataContexts"].getObject();w.shift();return this._getNode(w,N);};A._getNode=function(i,N){var u=null,w;while(i.length>0&&N){if(N.getObject){u=N.getObject(i.join("/"));}if(!u){w=i.shift();N=N[w];}else{return u;}}return N;};A.getContextName=function(){return n;};j[n]=A.getContext("/");if(j["metadataContexts"]){j["metadataContexts"].oModel.setProperty("/"+n,j[n]);}}function g(i,v,o,j,s){o.model=o.model||s;var K=o.name||o.model||undefined;if(j[K]){return;}try{i[K]=v.getContext(o.model+">"+o.path);j[K]=i[K];}catch(n){i["_$error"].oModel.setProperty("/"+K,n);}}function h(i,v,s,n,o){if(!s&&!n){return;}var r=s?b.bindingParser(s):{parts:[]};var u=n?b.bindingParser(n):{parts:[]};if(!u.parts){u={parts:[u]};}if(!r.parts){r={parts:[r]};}q.merge(r.parts,u.parts);for(var j=0;j<r.parts.length;j++){g(i,v,r.parts[j],r,o);v=v["with"](i,false);}var w=new J(r);i["metadataContexts"]=w.getContext("/");}function k(P){var s={};s.models=P.oModels||{};s.bindingContexts=P.oBindingContexts||{};return s;}function t(P,o,i){var A=o._aggregationFragments,L=o.getLibraryName(),n;if(A){Object.keys(A).forEach(function(s){var r=o.getAggregation(s);if(!r){return true;}var u=P.getElementsByTagNameNS(L,s)[0];if(!u){u=document.createElementNS(L,s);P.appendChild(u);n=false;}else{n=true;}if(n&&!r.multiple){return true;}var v=A[s].cloneNode(true);i.visitChildNodes(v);for(var j=v.childElementCount;j>0;j--){u.appendChild(v.children[0]);}});}}var l=C.extend("sap.ui.core.XMLComposite",{metadata:{properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:'100%',invalidate:true},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null,invalidate:true},displayBlock:{type:"boolean",group:"Appearance",defaultValue:true,invalidate:true}},aggregations:{_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}}},constructor:function(i,s){this._bIsCreating=true;C.apply(this,arguments);delete this._bIsCreating;},renderer:function(r,o){r.write("<div");r.writeControlData(o);if(!o.getDisplayBlock()&&(o.getWidth()!=="100%"||o.getHeight()!=="100%")){r.addStyle("display","inline-block");}r.writeClasses();if(o.getHeight()){r.addStyle("height",o.getHeight());}if(o.getWidth()){r.addStyle("width",o.getWidth());}r.writeStyles();r.write(">");var i=o.getAggregation(o.getMetadata().getCompositeAggregationName());if(i){r.renderControl(i);}r.write("</div>");}},X);l.prototype.byId=function(i){return sap.ui.getCore().byId(F.createId(this.getId(),i));};l.prototype._getManagedObjectModel=function(){if(!this._oManagedObjectModel){this._oManagedObjectModel=new M(this);}return this._oManagedObjectModel;};l.prototype.getSuppressInvalidateAggregation=function(n,s){var o=this.getMetadata(),A=o.getAggregation(n)||o.getAllPrivateAggregations()[n];if(!A){return true;}s=o._suppressInvalidate(A,s);o._requestFragmentRetemplatingCheck(this,A);return s;};l.prototype.setProperty=function(n,v,s){var o=this.getMetadata(),P=o.getProperty(n);if(!P){return this;}s=this.getMetadata()._suppressInvalidate(P,s);if(C.prototype.getProperty.apply(this,[n])!==v){o._requestFragmentRetemplatingCheck(this,P);}return C.prototype.setProperty.apply(this,[n,v,s]);};l.prototype.bindAggregation=function(n,o){var i=this.getMetadata(),A=i.getAggregation(n)||i.getAllPrivateAggregations()[n],B=C.prototype.getBinding.apply(this,[n]);if(!B||(B&&B.getPath()!==o.path)){i._requestFragmentRetemplatingCheck(this,A);}return C.prototype.bindAggregation.apply(this,[n,o]);};l.prototype.unbindAggregation=function(n){var o=this.getMetadata(),A=o.getAggregation(n)||o.getAllPrivateAggregations()[n];if(this.isBound(n)){o._requestFragmentRetemplatingCheck(this,A,true);}return C.prototype.unbindAggregation.apply(this,[n]);};l.prototype.setAggregation=function(n,o,s){return C.prototype.setAggregation.apply(this,[n,o,this.getSuppressInvalidateAggregation(n,s)]);};l.prototype.addAggregation=function(n,o,s){return C.prototype.addAggregation.apply(this,[n,o,this.getSuppressInvalidateAggregation(n,s)]);};l.prototype.insertAggregation=function(n,o,i,s){return C.prototype.insertAggregation.apply(this,[n,o,i,this.getSuppressInvalidateAggregation(n,s)]);};l.prototype.removeAggregation=function(n,o,s){return C.prototype.removeAggregation.apply(this,[n,o,this.getSuppressInvalidateAggregation(n,s)]);};l.prototype.removeAllAggregation=function(n,s){return C.prototype.removeAllAggregation.apply(this,[n,this.getSuppressInvalidateAggregation(n,s)]);};l.prototype.destroyAggregation=function(n,s){return C.prototype.destroyAggregation.apply(this,[n,this.getSuppressInvalidateAggregation(n,s)]);};l.prototype.updateAggregation=function(n,s){var A=this.getMetadata().getAggregation(n);if(A&&A.type==="TemplateMetadataContext"){this.invalidate();return;}C.prototype.updateAggregation.apply(this,arguments);};l.prototype.setVisible=function(v){this.setProperty("visible",v);if(this.getParent()){this.getParent().invalidate();}return this;};l.prototype._destroyCompositeAggregation=function(){var s=this.getMetadata().getCompositeAggregationName(),o=this.getAggregation(s);if(o){o.destroy();}return this;};l.prototype.updateBindings=function(){if(this._bIsInitializing){return;}var r=C.prototype.updateBindings.apply(this,arguments);for(var n in this.mBindingInfos){var A=this.getMetadata().getAggregation(n);if(A&&A.multiple&&!A._doesNotRequireFactory&&this.isBound(n)&&!this.getBinding(n)){this[A._sDestructor]();}}return r;};l.prototype._setCompositeAggregation=function(n){var s=this.getMetadata().getCompositeAggregationName();this._destroyCompositeAggregation();if(!this._oManagedObjectModel){this._getManagedObjectModel();}if(q.isArray(n)){this.setAggregation(s,null);return;}if(n){n.setModel(this._oManagedObjectModel,"$"+this.alias);n.bindObject("$"+this.alias+">/");var r=this._getResourceModel();if(r){n.setModel(r,"$"+this.alias+".i18n");}}this.setAggregation(s,n);this.invalidate();};l.mResourceModels={};l.getLibraryResourceModel=function(L){var o=l.mResourceModels[L];if(!o){o=new R({bundleName:L+".messagebundle",async:true});l.mResourceModels[L]=o;}return o;};l.prototype._getResourceModel=function(){if(this.resourceModel){return this.resourceModel;}if(this.messageBundle){this.resourceModel=new R({bundleName:this.messageBundle,async:true});return this.resourceModel;}else{this.sLibraryName=this.sLibraryName||this.getMetadata().getLibraryName();return l.getLibraryResourceModel(this.sLibraryName);}};l.prototype.getResourceBundle=function(){var r=this._getResourceModel();return r?r.getResourceBundle():null;};l.prototype.destroy=function(){C.prototype.destroy.apply(this,arguments);if(this.resourceModel){this.resourceModel.destroy();}};l.prototype._initCompositeSupport=function(s){var o=this.getMetadata(),A=o.getCompositeAggregationName(),i=false;if(s&&A){var n=s[A];if(n instanceof b){this._destroyCompositeAggregation();this._setCompositeAggregation(n);i=true;}else{if(n&&n.localName==="FragmentDefinition"){this._destroyCompositeAggregation();this._setCompositeAggregation(sap.ui.xmlfragment({sId:this.getId(),fragmentContent:s[A],oController:this}));i=true;}}delete s[A];}if(!i){this._destroyCompositeAggregation();this._setCompositeAggregation(sap.ui.xmlfragment({sId:this.getId(),fragmentContent:this.getMetadata()._fragment,oController:this}));}};l.prototype.requestFragmentRetemplating=function(i){if(i){this.fragmentRetemplating();return;}var A=this.getMetadata().getMandatoryAggregations(),B=true;for(var n in A){B=typeof this.getBindingInfo(n)==="object";if(!B){break;}}if(B){this.fragmentRetemplating();}};l.prototype.fragmentRetemplating=function(){var o=this.getMetadata(),i=o.getFragment();if(!i){throw new Error("Fragment "+i.tagName+" not found");}var j=this._getManagedObjectModel();var n=this;j.getContextName=function(){return n.alias;};this.setModel(j,this.alias);this.bindObject(this.alias+">/");j._mSettings=k(this._getPropertiesToPropagate());delete j._mSettings.models["$"+this.alias];delete j._mSettings.bindingContexts["$"+this.alias];this.setModel(null,this.alias);a.process(i.querySelector("*"),{},j._mSettings);var s={};s[o.getCompositeAggregationName()]=i;this._initCompositeSupport(s);};l.initialTemplating=function(E,v,s){var i=e(s),o=new J({}),j={"_$error":o.getContext("/")},n=i.getMetadata(),r=n.getFragment(),u=n._mSpecialSettings.metadataContexts?n._mSpecialSettings.metadataContexts.defaultValue:"";if(!r){throw new Error("Fragment "+s+" not found");}h(j,v,E.getAttribute("metadataContexts"),u,i.prototype.defaultMetaModel);f(j,i.prototype.alias,E,i,v);var w=v["with"](j,true);t(E,n,w);w.visitChildNodes(r);var N=r.ownerDocument.createElementNS("http://schemas.sap.com/sapui5/extension/sap.ui.core.xmlcomposite/1",n.getCompositeAggregationName());N.appendChild(r);E.appendChild(N);};return l;});
