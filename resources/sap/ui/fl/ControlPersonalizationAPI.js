/*
 * ! UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/ui/fl/registry/ChangeRegistry","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/fl/variants/VariantManagement","sap/ui/core/Component"],function(U,C,J,E,V,a){"use strict";var b="sap-ui-fl-control-variant-id";var c={_determineParameters:function(o){var A=U.getAppComponentForControl(o);var r=A.getRootControl();var v=U.getViewForControl(o);var d=A.getModel("$FlexVariants");var p={appComponent:A,rootControl:r,view:v,variantModel:d,variantManagement:{}};var e;var f;jQuery.makeArray(p.rootControl.$().find(".sapUiFlVarMngmt")).map(function(g){e=sap.ui.getCore().byId(g.id);if(e.getMetadata().getName()==="sap.ui.fl.variants.VariantManagement"){f=e.getFor();f.forEach(function(s){p.variantManagement[s]=p.variantModel._getLocalId(g.id,p.appComponent);});}});return p;},_getVariantManagement:function(o){var p=this._determineParameters(o);var f=function(o){if(!p.variantManagement[o.getId()]&&o.getParent()&&o.getId()!==p.rootControl.getId()){return f(o.getParent());}else if(!o.getParent()||o.getId()===p.rootControl.getId()){return p.variantManagement[o.getId()]||"";}else{return p.variantManagement[o.getId()];}};return f(o);},clearVariantParameterInURL:function(o){var u=[];var A=U.getAppComponentForControl(o);var v=A instanceof a?A.getModel("$FlexVariants"):undefined;if(!v){U.setTechnicalURLParameterValues(undefined,b,u);return U.log.error("Variant model could not be found on the provided control");}if(o instanceof V){var s=v._getLocalId(o.getId(),A);var m=v.getVariantIndexInURL(s);if(m.index>-1){m.parameters[b].splice(m.index,1);u=m.parameters[b].slice(0);}}v.updateHasherEntry({parameters:u,updateURL:true,component:A});},activateVariant:function(e,v){var o;return Promise.resolve().then(function(){if(typeof e==='string'||e instanceof String){o=sap.ui.getCore().getComponent(e);if(!(o instanceof a)){o=sap.ui.getCore().byId(e);if(!(o instanceof E)){throw new Error("A valid component or control cannot be found for the provided Id");}}}else if(e instanceof a||e instanceof E){o=e;}var A=U.getAppComponentForControl(o);if(!A){throw new Error("A valid variant management control or component (instance or id) should be passed as parameter");}var d=A.getModel("$FlexVariants");if(!d){throw new Error("No variant management model found for the passed control or component");}var s=d.getVariantManagementReference(v).variantManagementReference;if(!s){throw new Error("A valid control or component, and variant id combination is required");}return d.updateCurrentVariant(s,v);})["catch"](function(d){U.log.error(d);return Promise.reject(d);});},addPersonalizationChanges:function(d){var o;var v;var s;var S;var m;var e;var f;var p;var P;var g;var h;var j=[];var l=U.getCurrentLayer(true);var G=function(q,r){var t=r.getMetadata().getName();return C.getInstance().getChangeHandler(q,t,r,J,l);};var k=function(m){var g;if(!m.selectorControl||!m.selectorControl.getMetadata){g={change:m,message:"No valid selectorControl"};}else{if(!m.changeSpecificData){g={change:m,message:"No changeSpecificData available"};}else if(!m.changeSpecificData.changeType){g={change:m,message:"No valid changeType"};}else{o=G(m.changeSpecificData.changeType,m.selectorControl);if(!o){g={change:m,message:"No valid ChangeHandler"};}else if(!o.revertChange){g={change:m,message:"ChangeHandler has no revertChange function"};}}}return g;};var A=function(h,S,p){P.variantModel.oFlexController.addPreparedChange(h,P.appComponent);return P.variantModel.oFlexController.checkTargetAndApplyChange(h,S,p);};var n=function(g){return Promise.reject(g);};for(var i=0;i<d.length;i++){m=d[i];e={};jQuery.extend(e,{developerMode:false,layer:l});g=k(m);if(g){j.push(n.bind(this,g));}else{f=m.changeSpecificData;S=m.selectorControl;if(!P){P=this._determineParameters(S);}v=this._getVariantManagement(S);s=undefined;if(!v){g={change:m,message:"No Variant Management Control available for change"};j.push(n.bind(this,g));}else{s=P.variantModel.oData[v].currentVariant;h=P.variantModel.oFlexController.createChange(jQuery.extend(e,f),S,P.appComponent);h.setVariantReference(s);p={appComponent:P.appComponent,view:P.view,modifier:J};j.push(A.bind(this,h,S,p));}}}return U.execPromiseQueueSequentially(j);},hasVariantManagement:function(o){return!!this._getVariantManagement(o);}};return c;},true);
