/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/rta/plugin/Plugin','sap/ui/rta/Utils','sap/base/Log'],function(P,U,B){"use strict";var S=P.extend("sap.ui.rta.plugin.Settings",{metadata:{library:"sap.ui.rta",properties:{commandStack:{type:"any"}},associations:{},events:{}}});S.prototype._isEditable=function(o){var s=this.getAction(o);if(s){if(s.handler){return this.hasStableId(o);}else{var h=Object.keys(s).some(function(a){var b=s[a];return b.handler&&this._checkRelevantContainerStableID(b,o);}.bind(this));if(h){return this.hasStableId(o);}}}return false;};S.prototype.isEnabled=function(o){var a=this.getAction(o);if(!a){return false;}if(typeof a.isEnabled!=="undefined"){if(typeof a.isEnabled==="function"){return a.isEnabled(o.getElement());}else{return a.isEnabled;}}return true;};S.prototype._getUnsavedChanges=function(i,c){var e;var u=this.getCommandStack().getAllExecutedCommands().filter(function(C){e=C.getElementId&&C.getElementId()||C.getElement&&C.getElement().getId();if(e===i&&c.indexOf(C.getChangeType())>=0){return true;}}).map(function(C){return C.getPreparedChange();});return u;};S.prototype.handler=function(s,p){p=p||{};var o,a,c;var e=s[0].getElement();var h=p.fnHandler;if(!h){h=s[0].getDesignTimeMetadata().getAction("settings").handler;if(!h){throw new Error("Handler not found for settings action");}}p.getUnsavedChanges=this._getUnsavedChanges.bind(this);p.styleClass=U.getRtaStyleClassName();return h(e,p).then(function(C){if(C.length>0){c=this.getCommandFactory().getCommandFor(e,"composite");C.forEach(function(m){var b=m.changeSpecificData;if(b.changeType){var v;var d=m.selectorControl;var f;var g;if(d.controlType){f=d.controlType;}else{g=d;}var i=this._getChangeHandler(b.changeType,g,f);if(s[0].getVariantManagement&&i&&i.revertChange){v=s[0].getVariantManagement();}o=this.getCommandFactory().getCommandFor(d,"settings",b,undefined,v);c.addCommand(o);}else if(b.appDescriptorChangeType){var j=m.appComponent;var M=j.getManifest();var r=M["sap.app"].id;a=this.getCommandFactory().getCommandFor(e,"appDescriptor",{reference:r,appComponent:j,changeType:b.appDescriptorChangeType,parameters:b.content.parameters,texts:b.content.texts});c.addCommand(a);}},this);if(c.getCommands().length>0){this.fireElementModified({"command":c});}}}.bind(this))['catch'](function(E){if(E){throw E;}});};S.prototype.getMenuItems=function(o){var s=this.getAction(o);var r=110;var p="CTX_SETTINGS";if(s){if(s.handler&&this._checkRelevantContainerStableID(s,o)){return this._getMenuItems(o,{pluginId:p,rank:r,icon:this._getActionIcon(s)});}else{var m=[];var a=Object.keys(s);var A=0;a.forEach(function(b){var c=s[b];var d=this.getActionText(o,c,c.name);if(c.handler&&this._checkRelevantContainerStableID(c,o)){m.push({id:p+A,text:d,icon:this._getActionIcon(c),enabled:c.isEnabled&&c.isEnabled.bind(this,o.getElement()),handler:function(h,O,e){e=e||{};e.fnHandler=h;return this.handler(O,e);}.bind(this,c.handler),rank:r+A});A++;}else{B.warning("Handler not found for settings action '"+d+"' or relevant container has no stable id");}}.bind(this));return m;}}};S.prototype._getActionIcon=function(s){var d="sap-icon://key-user-settings",a=s.icon;if(!a){return d;}if(typeof a!=="string"){B.error("Icon setting for settingsAction should be a string");return d;}return a;};S.prototype.getActionName=function(){return"settings";};return S;},true);
