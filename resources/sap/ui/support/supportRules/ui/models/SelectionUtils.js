/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/support/supportRules/Constants","sap/ui/support/supportRules/Storage","sap/ui/support/supportRules/ui/models/SharedModel","sap/ui/core/util/File"],function(c,s,S,F){"use strict";var n=function n(a,b){return a-b;};var d={model:S,isRowAGroup:function(r){if(!r){return false;}var R=r.getModel();if(!R){return false;}var b=r.getBindingContext(),p=b.getPath();return R.getProperty(p+"/rules")!==undefined;},getChildIndicesRange:function(r,R){var o=r.getModel(),b=r.getBindingContext(),p=b.getPath(),m=o.getProperty(p),f=R+1,t=R,k;for(k in m){if(Number.isInteger(Number.parseInt(k,10))){t++;}}if(f>t){return null;}return{from:f,to:t};},selectAllRows:function(b){var m=this.model,t=m.getProperty("/treeViewModel/"),l;for(var i in t){if(Number.isInteger(Number.parseInt(i,10))){m.setProperty("/treeViewModel/"+i+"/selected",b);l=m.getProperty("/treeViewModel/"+i);for(var k in l){if(Number.isInteger(Number.parseInt(k,10))){m.setProperty("/treeViewModel/"+i+"/"+k+"/selected",b);}}}}if(s.readPersistenceCookie(c.COOKIE_NAME)){this.persistSelection();}},updateLibrarySelection:function(p,b){var m=this.model,r=this.getRowContextIndexByPath(p),l,a;while(r>=0){a=this.treeTable.getContextByIndex(r);p=a.getPath();l=m.getProperty(p);if(l.type==="lib"){break;}r--;}if(b){for(var i in l){if(Number.isInteger(Number.parseInt(i,10))&&!l[i].selected){return;}}this.treeTable.addSelectionInterval(r,r);}else{this.treeTable.removeSelectionInterval(r,r);}m.setProperty(p+"/selected",b);},updateTreeViewTempRulesSelection:function(t){this.treeTable.expand(0);var a=true;for(var r in t){var R=Number.parseInt(r,10);if(!Number.isInteger(R)){continue;}R++;var b=t[r];var m=false;var p=s.getSelectedRules();for(var i=0;i<p.length;i++){var e=p[i];if(b.id===e.ruleId&&b.libName===e.libName){m=true;break;}}if(m){this.treeTable.addSelectionInterval(R,R);}else{a=false;this.treeTable.removeSelectionInterval(R,R);}}if(a){this.model.setProperty("/treeViewModel/0/selected",true);this.treeTable.addSelectionInterval(0,0);}},getRowContextIndexByPath:function(p){var r=0,R=this.treeTable.getContextByIndex(r);while(R){if(R.getPath()==p){return r;}r++;R=this.treeTable.getContextByIndex(r);}},_syncSelections:function(N){var I=this._buildTreeTableIndex(),l=[],L={},m;for(var i in N){if(Number.isInteger(Number.parseInt(i,10))){for(var k in N[i]){var r=I[N[i][k].id];if(Number.isInteger(Number.parseInt(k,10))&&r&&r.selected){N[i][k].selected=r.selected;if(l.indexOf(N[i][k].libName)<0){l.push(N[i][k].libName);}}}}}this.model.setProperty("/treeViewModel",N);m=this._buildTreeTableIndex();l.forEach(function(a){if(m[a]){L[a]=m[a];}});for(var K in m){if(m[K].type==="lib"&&!I[K]){L[K]=m[K];}}this.updateLibrariesSelection(L);},updateLibrariesSelection:function(l){var m=this.model,L,b;for(var a in l){L=m.getProperty(l[a].path);b=true;for(var i in L){if(Number.isInteger(Number.parseInt(i,10))){if(!L[i].selected){b=false;break;}}}this.updateLibrarySelection(l[a].path,b);}},initializeSelection:function(i){var p=this.model.getProperty("/persistingSettings"),m=this.model,I={},l=[],a;if(p){a=s.getSelectedRules()||[];if(a.length===0){return;}I=this._buildTreeTableIndex();a.forEach(function(r){var R=I[r.ruleId];if(R){m.setProperty(R.path+"/selected",true);this.treeTable.addSelectionInterval(R.index,R.index);if(I[R.libName]){l[R.libName]=I[R.libName];}}},this);this.updateLibrariesSelection(l);}else if(i){this.treeTable.selectAll();}},initializeModelSelection:function(){var t=this.model.getProperty("/treeViewModel");var r=s.getSelectedRules();var T=this.treeTable;T.expandToLevel(1);var i=-1;Object.keys(t).map(function(N){return Number.parseInt(N,10);}).sort(n).forEach(function(l,L){i+=1;var a=i;var A=true;Object.keys(t[l]).filter(function(R){return Number.isInteger(Number.parseInt(R,10));}).map(function(N){return Number.parseInt(N,10);}).sort(n).forEach(function(R,b){i+=1;var o=t[l][R];r.forEach(function(e){if(o.id===e.ruleId&&o.libName===e.libName){o.selected=true;}});if(o.selected===true){T.addSelectionInterval(i,i);}else{T.removeSelectionInterval(i,i);A=false;}});if(i===a){A=false;}t[l].selected=A;if(A){T.addSelectionInterval(a,a);}else{T.removeSelectionInterval(a,a);}});},_buildTreeTableIndex:function(){var i=0,p=this.treeTable.getBinding().getPath()+'/',m=this.model,I={},l=m.getProperty(p+i),a=0,g=0,r;while(l){I[l.name]={index:g,path:p+i,libName:l.name,type:"lib",selected:l.selected};g++;r=m.getProperty(p+i+'/'+a);while(r){I[r.id]={index:g,path:p+i+'/'+a,libName:r.libName,type:"rule",selected:r.selected};a++;g++;r=m.getProperty(p+i+'/'+a);}i++;l=m.getProperty(p+i);}return I;},getVisualIndex:function(r){var R=this.treeTable.getRows(),o,i;for(i=0;i<R.length;i++){o=R[i];if(o.getBindingContext()==r){return i;}}},selectionChangeHandler:function(e){var i=e.getParameter("rowIndex"),r=e.getParameter("rowContext"),R=e.getParameter("rowIndices"),u=e.getParameter("userInteraction");if(e.getParameter("selectAll")){this.selectAllRows(true);return;}if(i===-1){this.selectAllRows(false);return;}if(!u||R.length!=1||R[0]!=i){return;}var t=this.treeTable,a=t.getRows(),v=this.getVisualIndex(r),o=a[v],b=o.getModel(),B=o.getBindingContext(),p=B.getPath(),m=b.getProperty(p),f=!b.getProperty(p+"/selected"),C,k;b.setProperty(p+"/selected",f);if(this.isRowAGroup(o)){C=this.getChildIndicesRange(o,i);if(!C){return;}for(k in m){if(Number.isInteger(Number.parseInt(k,10))){b.setProperty(p+"/"+k+"/selected",f);}}if(t.isExpanded(i)){if(f){t.addSelectionInterval(C.from,C.to);}else{t.removeSelectionInterval(C.from,C.to);}}}else{this.updateLibrarySelection(p,f);}if(s.readPersistenceCookie(c.COOKIE_NAME)){this.persistSelection();}},toggleOpenStateHandler:function(e){var i=e.getParameter("rowIndex"),r=e.getParameter("rowContext"),E=e.getParameter("expanded"),t=this.treeTable,R=t.getRows(),v=this.getVisualIndex(r),o=R[v],a=o.getModel(),b=o.getBindingContext(),p=b.getPath(),m=a.getProperty(p),k,f,g=i+1;if(!E){return;}for(k in m){if(Number.isInteger(Number.parseInt(k,10))){f=a.getProperty(p+"/"+k+"/selected");if(f){t.addSelectionInterval(g,g);}else{t.removeSelectionInterval(g,g);}g++;}}},getSelectedRulesPlain:function(){var m=this.model,a=[],r;for(var i in m.getProperty("/treeViewModel/")){if(Number.isInteger(Number.parseInt(i,10))){for(var k in m.getProperty("/treeViewModel/"+i)){r=m.getProperty("/treeViewModel/"+i+"/"+k);if(Number.isInteger(Number.parseInt(k,10))&&r&&r.selected){a.push({ruleId:r.id,libName:r.libName});}}}}return a;},persistSelection:function(){var a=this.getSelectedRulesPlain();s.setSelectedRules(a);},exportSelectedRules:function(t,a){var b=this.getSelectedRulesPlain();var r={title:t,description:a,selections:b};var e=JSON.stringify(r);F.save(e,c.RULE_SELECTION_EXPORT_FILE_NAME,'json','text/plain');},isValidSelectionImport:function(I){var b=true;if(!I.hasOwnProperty("title")){b=false;}if(!I.hasOwnProperty("description")){b=false;}if(!I.hasOwnProperty("selections")){b=false;}else if(!Array.isArray(I.selections)){b=false;}else{for(var i=0;i<I.selections.length;i++){var r=I.selections[i];if(!r.hasOwnProperty("ruleId")||!r.hasOwnProperty("libName")){b=false;break;}}}return b;}};return d;});
